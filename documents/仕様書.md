# Live2Dキャラクター表示アプリケーション 仕様書
- 文書ID: SPEC-L2D-APP
- 版数: v0.4
- 作成日: 2026-02-14
- 更新日: 2026-02-14

---

## 0. 改訂履歴
| 版 | 日付 | 変更者 | 変更内容 |
|---|---|---|---|
| v0.1 | YYYY-MM-DD |  | ひな型作成 |
| v0.2 | 2026-02-14 | user | 前提（Built-in / StreamingAssets差し替え）を確定 |
| v0.3 | 2026-02-14 | user | API制御/透過/自動挙動/将来リップシンクを追加 |
| v0.4 | 2026-02-14 | user | API仕様を確定（表形式・レスポンス/エラー/WSイベント定義） |

---

## 1. 用語・略語
| 用語 | 説明 |
|---|---|
| Live2D | Live2D Cubism |
| Cubism SDK | Cubism SDK for Unity |
| モデル | `.model3.json` を起点とするモデル一式 |
| モーション | `*.motion3.json` |
| 表情 | `*.exp3.json` |
| StreamingAssets | `Assets/StreamingAssets/`。ビルド後もファイルとして同梱される |
| Overlay | 他画面と重ねるための表示モード（透過/最前面/クリック透過等） |

---

## 2. 背景・目的
### 2.1 背景
- Unity上でLive2Dキャラクターを常駐表示し、他アプリからAPIで制御したい。
- モデルは配布後に差し替えたい（再ビルド不要）。

### 2.2 目的
- Unity + Live2Dでキャラクター表示を提供する「表示サーバ」を構築する。
- ローカルAPIにより、モデル切替・表情・アクション・座標/拡大率を制御可能にする。
- 背景透過のオーバーレイ利用を可能にする。
- 将来のリップシンク拡張（TTS連携）に備えた入力口を用意する。

### 2.3 ゴール / 非ゴール
**ゴール**
- ローカルAPI（localhost）による制御
- モデル切替（StreamingAssets走査 + ロード）
- 呼吸・瞬きの自動挙動（ON/OFF/強度をAPI制御）
- 表情適用（API）
- アクション（モーション）再生（API、優先度で割り込み）
- 座標/拡大率/バストアップ相当の見せ方（API）
- 背景透過（Overlay）
- 将来拡張：リップシンク入力（RMS/ビセム）

**非ゴール（現時点）**
- インターネット越しの公開API（LAN/外部公開は不可）
- モバイル対応（StreamingAssets差し替え運用が成立しないため）
- モデル制作/編集機能

---

## 3. スコープ
### 3.1 前提（固定）
- Unityレンダーパイプライン：Built-in（固定）
- モデル供給：StreamingAssets差し替え（固定）
- API：localhost固定（127.0.0.1）

### 3.2 対応プラットフォーム
- OS：Windows 10/11（想定）
- 配布形態：Standalone（exe）

---

## 4. 全体概要
- 本アプリは「Live2D常駐表示 + ローカルAPIサーバ」として動作する。
- UnityメインスレッドでLive2D/Unityオブジェクト操作を行い、APIスレッドからはDispatcher経由で実行する。

---

## 5. 機能要件（要約）
- MUST：APIサーバ、モデル切替、呼吸/瞬き自動、表情、モーション、Transform制御、Overlay、設定保存、ログ
- SHOULD：ショートカット、ドラッグ移動、ホイール拡大縮小、デバッグHUD
- MAY：外部入力（OSC/WS）、リップシンク実装、クリック透過、最前面固定

---

## 7. データ仕様
### 7.1 モデル配置（固定）
- ルート：`Assets/StreamingAssets/Live2D/`
- `model_id` は原則フォルダ名と一致させる

例：
```

StreamingAssets/Live2D/
ModelA/
ModelA.model3.json
ModelA.moc3
textures/...
motions/...
expressions/...

````

### 7.2 ID仕様
- `model_id`：フォルダ名
- `expression_id`：expファイル名（拡張子除く）
- `motion_id`：motionファイル名（拡張子除く）
- `group`：モーション/表情のグルーピング（任意。サブフォルダ名などで表現）

---

## 8. 非機能要件
### 8.1 性能（目標）
- FPS：60（目標）
- 起動〜初回表示：3秒以内（目標）
- モデル切替：2秒以内（目標、モデルサイズに依存）

### 8.2 信頼性
- 欠損ファイル/不正IDはエラー応答＋ログ出力で継続可能な範囲で継続
- API例外はクラッシュさせず、Eコードで返す

### 8.3 セキュリティ（ローカル前提）
- バインドは 127.0.0.1 固定
- 任意でトークン（APIキー）を要求可能

---

## 9. アーキテクチャ設計（概要）
| モジュール | 役割 |
|---|---|
| ApiServer | HTTP/WS受け口 |
| CommandDispatcher | メインスレッド実行キュー |
| ModelCatalog | StreamingAssets走査→モデル一覧 |
| ModelLoader | モデルロード/破棄 |
| AutoBehavior | 呼吸/瞬きなど |
| ExpressionController | 表情列挙・適用 |
| MotionController | モーション列挙・再生/停止 |
| TransformController | 位置/スケール/見せ方制御 |
| WindowOverlay | 透過/最前面/クリック透過（必要に応じてネイティブ連携） |
| SettingsService | config読込/保存 |
| LogService | ログ |

---

# 10. API仕様（確定）

## 10.1 通信方式・共通仕様
### 10.1.1 HTTP
- Base URL：`http://127.0.0.1:{port}`
- 既定ポート：`27182`
- Content-Type：`application/json; charset=utf-8`
- 文字コード：UTF-8
- タイムアウト（推奨）：2〜5秒（クライアント側）

### 10.1.2 WebSocket（任意）
- URL：`ws://127.0.0.1:{port}/v1/ws`
- 目的：状態変化イベント通知（モーション完了、モデル切替完了など）

### 10.1.3 認証（任意）
- 方式：ヘッダ `X-Api-Key: <token>`
- 設定：`config.json` に `api_key_required` / `api_key` を保持可能
- `api_key_required=false` の場合は不要

### 10.1.4 共通レスポンス形式
成功：
```json
{
  "ok": true,
  "request_id": "uuid",
  "timestamp": "2026-02-14T12:00:00+09:00",
  "data": { }
}
````

失敗：

```json
{
  "ok": false,
  "request_id": "uuid",
  "timestamp": "2026-02-14T12:00:00+09:00",
  "error": {
    "code": "E120",
    "message": "Model load failed",
    "details": { }
  }
}
```

### 10.1.5 HTTPステータス運用

* 200：アプリ側処理の成否は `ok` で判定（原則）
* 400：JSON不正、必須パラメータ欠落など（E100）
* 401：APIキー必須/不一致（E401）
* 404：未知のエンドポイント
* 409：競合（ロード中に再切替など）（E409）
* 500：内部エラー（E500）

---

## 10.2 エラーコード一覧

| code | 意味                  | 代表原因                          |
| ---- | ------------------- | ----------------------------- |
| E100 | Bad Request         | JSON不正、必須項目欠落、型不一致            |
| E110 | Not Found: Model    | model_idが存在しない                |
| E120 | Model Load Failed   | ファイル欠損、SDK読込失敗                |
| E130 | Not Found: Asset ID | expression_id/motion_idが存在しない |
| E140 | Overlay Unsupported | 透過/最前面等が環境非対応                 |
| E401 | Unauthorized        | APIキー必須/不一致                   |
| E409 | Conflict            | ロード中、再生中に不正な操作                |
| E500 | Internal Error      | 例外発生                          |

---

## 10.3 エンドポイント定義（表）

### 10.3.1 ヘルスチェック

| 項目             | 内容                                     |
| -------------- | -------------------------------------- |
| Method/Path    | GET `/v1/health`                       |
| 説明             | サーバ稼働確認                                |
| Request        | なし                                     |
| Response(data) | `{ "status":"ok", "version":"0.4.0" }` |

---

### 10.3.2 モデル一覧

| 項目             | 内容                                                                                                       |
| -------------- | -------------------------------------------------------------------------------------------------------- |
| Method/Path    | GET `/v1/models`                                                                                         |
| 説明             | StreamingAssets走査結果の取得                                                                                   |
| Request        | なし                                                                                                       |
| Response(data) | `{ "models":[{"model_id":"ModelA","display_name":"ModelA","has_expressions":true,"has_motions":true}] }` |
| 備考             | `display_name` は初期は `model_id` と同一でよい                                                                    |

---

### 10.3.3 モデル切替

| 項目             | 内容                                                                     |
| -------------- | ---------------------------------------------------------------------- |
| Method/Path    | POST `/v1/model/switch`                                                |
| 説明             | 指定モデルへ切替                                                               |
| Request        | `{ "model_id":"ModelA", "force":false }`                               |
| Response(data) | `{ "state":"loading" }` または `{ "state":"ready", "model_id":"ModelA" }` |
| Error          | E110 / E120 / E409                                                     |

**仕様**

* `force=true` の場合、現在のモーション再生等を停止して切替を優先する。
* 切替は非同期になり得るため、完了確認は `/v1/model/status` で行う。

---

### 10.3.4 モデル状態

| 項目             | 内容                     |         |                                                   |
| -------------- | ---------------------- | ------- | ------------------------------------------------- |
| Method/Path    | GET `/v1/model/status` |         |                                                   |
| 説明             | 現在のモデル/ロード状態           |         |                                                   |
| Response(data) | `{ "state":"ready      | loading | error", "model_id":"ModelA", "last_error":null }` |

---

### 10.3.5 表情一覧

| 項目             | 内容                                                                |
| -------------- | ----------------------------------------------------------------- |
| Method/Path    | GET `/v1/expressions`                                             |
| 説明             | 現在モデルの表情一覧                                                        |
| Response(data) | `{ "expressions":[{"expression_id":"smile","group":"default"}] }` |
| Error          | E409（モデル未ロード等）                                                    |

---

### 10.3.6 表情適用

| 項目             | 内容                                            |
| -------------- | --------------------------------------------- |
| Method/Path    | POST `/v1/expression/apply`                   |
| 説明             | 表情を適用                                         |
| Request        | `{ "expression_id":"smile", "fade_ms":200 }`  |
| Response(data) | `{ "applied":true, "expression_id":"smile" }` |
| Error          | E130 / E409                                   |

---

### 10.3.7 表情クリア（任意）

| 項目             | 内容                          |
| -------------- | --------------------------- |
| Method/Path    | POST `/v1/expression/clear` |
| 説明             | 表情を初期状態へ                    |
| Request        | `{ "fade_ms":200 }`         |
| Response(data) | `{ "cleared":true }`        |

---

### 10.3.8 モーション一覧

| 項目             | 内容                                                       |
| -------------- | -------------------------------------------------------- |
| Method/Path    | GET `/v1/motions`                                        |
| 説明             | 現在モデルのモーション一覧                                            |
| Response(data) | `{ "motions":[{"motion_id":"wave","group":"default"}] }` |

---

### 10.3.9 モーション再生

| 項目             | 内容                                                         |     |                                      |
| -------------- | ---------------------------------------------------------- | --- | ------------------------------------ |
| Method/Path    | POST `/v1/motion/play`                                     |     |                                      |
| 説明             | モーション（アクション）再生                                             |     |                                      |
| Request        | `{ "motion_id":"wave", "priority":"high                    | mid | low", "loop":false, "fade_ms":200 }` |
| Response(data) | `{ "started":true, "motion_id":"wave", "play_id":"uuid" }` |     |                                      |
| Error          | E130 / E409                                                |     |                                      |

**仕様**

* 優先度：`high` は割り込み、`mid` は条件付き、`low` は空いていれば再生。
* `play_id` はWSイベントで完了通知する際にも用いる。

---

### 10.3.10 モーション停止

| 項目             | 内容                     |                            |
| -------------- | ---------------------- | -------------------------- |
| Method/Path    | POST `/v1/motion/stop` |                            |
| 説明             | モーション停止                |                            |
| Request        | `{ "scope":"all        | current", "fade_ms":200 }` |
| Response(data) | `{ "stopped":true }`   |                            |

---

### 10.3.11 自動挙動（呼吸/瞬き）設定

| 項目             | 内容                                                                     |
| -------------- | ---------------------------------------------------------------------- |
| Method/Path    | POST `/v1/behavior/auto`                                               |
| 説明             | 自動挙動のON/OFF/強度                                                         |
| Request        | `{ "blink":true, "breath":true, "blink_gain":1.0, "breath_gain":1.0 }` |
| Response(data) | `{ "blink":true, "breath":true }`                                      |

---

### 10.3.12 Transform（座標・拡大率・見せ方）

| 項目             | 内容                                                       |                                                              |
| -------------- | -------------------------------------------------------- | ------------------------------------------------------------ |
| Method/Path    | POST `/v1/transform`                                     |                                                              |
| 説明             | 位置/拡大/見せ方（バストアップ相当）                                      |                                                              |
| Request        | `{ "x":0.0, "y":-1.5, "scale":1.2, "framing":"full       | bustup", "framing_param":{ "target":"chest", "zoom":1.3 } }` |
| Response(data) | `{ "x":0.0, "y":-1.5, "scale":1.2, "framing":"bustup" }` |                                                              |

**仕様**

* `framing` はアプリ内部の「見せ方プリセット」。初期は `full`/`bustup` の2種を提供する。
* `framing_param` は将来拡張用（プリセットの微調整）。

---

### 10.3.13 Overlay（背景透過・最前面・クリック透過）

| 項目             | 内容                                                              |                                                                                                        |
| -------------- | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| Method/Path    | POST `/v1/window/overlay`                                       |                                                                                                        |
| 説明             | オーバーレイ設定                                                        |                                                                                                        |
| Request        | `{ "transparent":true, "mode":"native                           | chromakey", "always_on_top":true, "click_through":false, "opacity":1.0, "chromakey_color":"#00FF00" }` |
| Response(data) | `{ "transparent":true, "mode":"native", "always_on_top":true }` |                                                                                                        |
| Error          | E140                                                            |                                                                                                        |

**仕様**

* `mode=native`：真の透過（OS依存、ネイティブ連携が必要になり得る）
* `mode=chromakey`：単色背景を出し、外部側でキー抜き（確実な逃げ道）

---

### 10.3.14 設定保存/読込

| 項目             | 内容                                                                                         |
| -------------- | ------------------------------------------------------------------------------------------ |
| Method/Path    | POST `/v1/settings/save`                                                                   |
| 説明             | 現在状態をconfigへ保存                                                                             |
| Request        | `{ "include":["model","transform","overlay","behavior","last_expression","last_motion"] }` |
| Response(data) | `{ "saved":true, "path":"<persistentDataPath>/config.json" }`                              |

| 項目             | 内容                                                       |
| -------------- | -------------------------------------------------------- |
| Method/Path    | POST `/v1/settings/load`                                 |
| 説明             | configから状態復元                                             |
| Request        | `{ "apply":["model","transform","overlay","behavior"] }` |
| Response(data) | `{ "loaded":true }`                                      |

---

### 10.3.15 将来拡張：リップシンク入力口（定義のみ）

| 項目             | 内容                        |
| -------------- | ------------------------- |
| Method/Path    | POST `/v1/lipsync/volume` |
| 説明             | 音量（RMS）入力                 |
| Request        | `{ "rms":0.42 }`          |
| Response(data) | `{ "accepted":true }`     |

| 項目             | 内容                                            |
| -------------- | --------------------------------------------- |
| Method/Path    | POST `/v1/lipsync/viseme`                     |
| 説明             | ビセムウェイト入力                                     |
| Request        | `{ "a":0.1,"i":0.0,"u":0.3,"e":0.0,"o":0.0 }` |
| Response(data) | `{ "accepted":true }`                         |

---

## 10.4 WebSocketイベント（任意）

### 10.4.1 受信イベント形式

```json
{
  "type": "model_changed|motion_started|motion_finished|expression_applied|state|error",
  "timestamp": "2026-02-14T12:00:00+09:00",
  "payload": { }
}
```

### 10.4.2 イベント一覧

| type               | payload例                                               | 説明          |         |
| ------------------ | ------------------------------------------------------ | ----------- | ------- |
| model_changed      | `{ "model_id":"ModelA" }`                              | モデル切替完了     |         |
| motion_started     | `{ "motion_id":"wave","play_id":"uuid" }`              | 再生開始        |         |
| motion_finished    | `{ "motion_id":"wave","play_id":"uuid","reason":"ended | stopped" }` | 再生完了/停止 |
| expression_applied | `{ "expression_id":"smile" }`                          | 表情適用        |         |
| state              | `{ "model_state":"ready","fps":60 }`                   | 定期状態通知（任意）  |         |
| error              | `{ "code":"E120","message":"..." }`                    | 非同期エラー通知    |         |

---

## 11. テスト要件（抜粋）

* HTTP API疎通（health）
* モデル一覧/切替/状態確認
* 表情/モーション（存在/不存在）での正常・異常系
* Transform反映
* Overlay（native/chromakey）の動作確認
* 設定save/load
* WSイベント（任意）

---

## 12. ビルド・配布

* 成果物：`App.exe` + `App_Data/` + `StreamingAssets/Live2D/...`
* ユーザー差し替え手順：

  1. アプリ終了
  2. `StreamingAssets/Live2D/<model_id>/` を置換
  3. アプリ起動
* Overlay（native）を採用する場合、ネイティブ連携DLL等が同梱される可能性がある。

---

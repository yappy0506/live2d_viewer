# Live2D Viewer 設計書

## 0. 仕様実装チェックリスト（仕様書 v0.4 から抽出）
- [x] `GET /v1/health` で稼働確認
- [x] `GET /v1/models` で `StreamingAssets/Live2D/*/*.model3.json` を列挙
- [x] `POST /v1/model/switch` / `GET /v1/model/status`
- [x] 表情一覧/適用（`/v1/expressions`, `/v1/expression/apply`）
- [x] モーション一覧/再生/停止（`/v1/motions`, `/v1/motion/play`, `/v1/motion/stop`）
- [x] 自動挙動（呼吸/瞬き）制御
- [x] Transform制御（x,y,scale,framing）
- [x] Overlay chromakey（`/v1/window/overlay`）
- [x] 設定 save/load（`config.json`）
- [x] ログ出力（`logs/app.log`）
- [x] リップシンク入力口（受理のみ）
- [ ] WebSocketイベント（任意のため未実装）
- [ ] native透過（現時点は E140 を返却）

## 1. 全体構成（モジュール一覧、責務、依存関係）
- `Live2DViewerApp`
  - アプリ起動時に自動生成されるエントリポイント
  - 各サービスの初期化、設定適用、APIハンドラ実体
- `LocalApiServer`
  - `HttpListener` で 127.0.0.1:27182 を待受
  - 入力JSONの最低限バリデーションとレスポンス整形
- `MainThreadDispatcher`
  - APIスレッドからの要求をキュー化し、`Update()` で実行
- `ModelCatalog`
  - `StreamingAssets/Live2D` 配下のモデル走査
- `Live2DModelRuntime`
  - `.model3.json` からモデル生成/破棄
  - 表情・モーション列挙と適用
  - 自動挙動（呼吸/瞬き）・Transform適用
- `OverlayController`
  - chromakey背景色制御
- `SettingsService`
  - `persistentDataPath/config.json` の保存/読込
- `AppLogger`
  - `persistentDataPath/logs/app.log` 出力（INFO/WARN/ERROR）

依存の向き：
`LocalApiServer -> MainThreadDispatcher -> Live2DViewerApp -> (Runtime/Overlay/Settings/Catalog/Logger)`

## 2. スレッド設計（ApiServer → Dispatcher → Unityメインスレッド）
- `LocalApiServer` はバックグラウンドスレッドでHTTP受付。
- Unity/Live2Dオブジェクト操作が必要なAPIは **必ず** `MainThreadDispatcher.Enqueue()` を通す。
- Dispatcherがメインスレッド `Update()` でデキューし、`Live2DViewerApp` のハンドラを実行。
- これにより、仕様書の「APIスレッドから直接Unity操作禁止」を満たす。

## 3. データフロー（StreamingAssets走査→model3.json→モデル生成）
1. `ModelCatalog.Scan()` が `Application.streamingAssetsPath/Live2D` 配下を走査。
2. サブフォルダ名を `model_id` とし、最初の `*.model3.json` を採用。
3. `POST /v1/model/switch` で `Live2DModelRuntime.SwitchModel()` 実行。
4. `CubismModel3Json.LoadAtPath(path, customLoader)` でファイルシステムから読み込み。
5. `ToModel()` でLive2Dモデルを生成。
6. `.exp3.json` / `.motion3.json` を抽出し、API用IDを構築。

## 4. API実装仕様（仕様書との一致/差分）
- 一致:
  - 主要HTTPエンドポイント、共通レスポンス構造、エラーコード運用（E100/E110/E120/E130/E140/E401/E409/E500）
  - 127.0.0.1固定、既定ポート27182
- 差分（暫定）:
  - `/v1/expression/clear` は任意のため未実装。
  - WS `/v1/ws` は任意のため未実装。
  - `motion priority=mid/low` はCubism優先度へ近似マップ（mid=Normal, low=Idle）。
  - `fade_ms` は受理のみ（現時点で実再生パラメータには未反映）。
  - `/v1/settings/save/load` の `include/apply` フィルタは未解釈（全項目を保存/適用）。

## 5. Overlay方式（chromakey/native）と制約
- 実装:
  - `mode=chromakey` のみ有効。
  - `chromakey_color` をCamera背景色へ適用。
- 制約:
  - `mode=native` は `E140` を返却（Windows透過のネイティブ実装未投入）。
  - `always_on_top` / `click_through` / `opacity` は設定保持+ログ出力のみ（動作反映は今後）。
- Windows注意:
  - 真透過にはWin32 API（拡張スタイル、DWM、透過描画）連携が必要。

## 6. 設定保存とログ出力
- 設定:
  - `Application.persistentDataPath/config.json`
  - 保存項目：model/transform/overlay/behavior/last_expression/last_motion/api_key設定
- ログ:
  - `Application.persistentDataPath/logs/app.log`
  - フォーマット：`ISO8601<TAB>LEVEL<TAB>message`

## 7. ビルド/実行手順、モデル差し替え手順
1. Unity Editorでプロジェクトを開く（Built-in RP）。
2. Playで起動するとAPIが自動起動。
3. モデルを `Assets/StreamingAssets/Live2D/<model_id>/...` に配置。
4. `GET /v1/models` で反映確認。
5. `POST /v1/model/switch` で切替。

差し替え:
1. アプリ終了
2. `StreamingAssets/Live2D/<model_id>/` を置換
3. 再起動

## 8. トラブルシュート
- モデル読込失敗（E120）
  - `*.model3.json`、参照moc3/texture/exp/motionの相対パスを確認
  - `logs/app.log` の例外詳細を確認
- Live2D Physics で NullReferenceException が出る
  - 一部モデルで Cubism Physics の実行時例外が発生するため、現実装では `CubismPhysicsController` を自動無効化してクラッシュ回避
  - 物理挙動が必要な場合は該当モデルの physics 設定整合性を確認のうえ再有効化を検討
- 透過が効かない
  - `mode=chromakey` を使用し、配信/キャプチャ側でキー抜きを設定
  - `native` は現実装で非対応（E140）
- ポート衝突
  - 27182 が使用中。起動ログ・例外ログを確認し、将来設定化TODO

## 9. 将来拡張
- WebSocketイベント
  - `model_changed`, `motion_started/finished`, `error` を push
- リップシンク入力
  - `/v1/lipsync/volume`, `/v1/lipsync/viseme` を実パラメータへ反映
- native透過強化
  - Windowsネイティブプラグインを追加し、最前面/クリック透過/不透明度を実装

## 10. 前提/判断/TODO
- 前提:
  - 仕様書v0.4をSoTとして実装。
- 判断:
  - 任意機能（WS、expression/clear）は最小構成優先で未実装。
  - native透過はE140返却で明示的に未対応。
- TODO:
  - `include/apply` フィルタ対応
  - `fade_ms` の実反映
  - `always_on_top/click_through/opacity` のWindows実装
  - APIポートの設定ファイル化
